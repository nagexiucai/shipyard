defaults: &defaults
  working_directory: /go/src/github.com/opsforgeio/shipyard
  docker:
    - image: circleci/golang:1.8

version: 2
jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Run GO test suite
          command: |
            go get -v -t -d ./...
            go get -d github.com/stretchr/testify/assert
            go get github.com/tools/godep
            bash test.sh

  build:
    working_directory: /go/src/github.com/opsforgeio/shipyard
    docker:
      - image: golang:1.8.5-jessie
    steps:
      - checkout
      - run:
          name: Build controller binary
          command: |
            curl -sL https://deb.nodesource.com/setup | bash -
            apt-get update
            apt-get install -y nodejs wget curl gunzip
            apt-get clean
            npm install -g bower
            go get github.com/tools/godep
            wget -P /tmp https://download.docker.com/linux/static/stable/x86_64/docker-17.09.0-ce.tgz
            gunzip /tmp/docker-17.09.0-ce.tgz
            tar -xvf /tmp/docker-17.09.0-ce.tar
            cp /tmp/docker/docker /usr/local/bin/docker
            chmod +x /usr/local/bin/docker
            rm -rf /tmp/docker*
            make build
      - persist_to_workspace:
          root: /tmp/build
          paths:
            - controller

  deploy:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: /tmp/build
      - run:
          name: Build and push docker images
          command: |
            cp /tmp/build/controller ./controller/
            chmod +x ./controller/controller
            make clean
            make image
            make release

workflows:
  version: 2
  cicd:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy:
          requires:
            - build
